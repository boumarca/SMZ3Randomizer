using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;

namespace Randomizer.SMZ3.FileData {

    public class Zspr {

        private readonly static char[] Header = "ZSPR".ToCharArray();
        private const int Version = 1;

        private const int SpriteType = 1;

        public string Title { get; private set; } = string.Empty;
        public string Author { get; private set; } = string.Empty;
        public string AuthorAscii { get; private set; } = string.Empty;

        public byte[] Content { get; private set; } = Array.Empty<byte>();

        private static readonly IList<int> fields = new[] {
            0x7000, // sprite
            4 * 30, // palette
            4,      // gloves
        };

        public static Zspr Parse(Stream stream) {
            using var data = new BinaryReader(stream, Encoding.ASCII, true);
            if (!data.ReadChars(4).SequenceEqual(Header))
                throw new InvalidDataException("Could not find the ZSPR format header");
            var version = stream.ReadByte();
            if (version != Version)
                throw new Exception($"ZSPR version {version} is not supported, expected version ${Version}");

            stream.Position += 4; // skip checksum

            var spriteOffset = data.ReadUInt32();
            stream.Position += 2; // skip sprite length
            var paletteOffset = data.ReadUInt32();
            stream.Position += 2; // skip palette length

            var type = data.ReadUInt16();
            if (type != SpriteType)
                throw new Exception($"Expected type {SpriteType} (Link Sprite) but found type {type}");

            stream.Position += 6; // six reserved bytes

            using var utf16_data = new BinaryReader(stream, Encoding.Unicode, true);
            var title = NullTerm(utf16_data);
            var author = NullTerm(utf16_data);

            var authorAscii = NullTerm(data);

            var content = ParseContent(stream, new[] {
                spriteOffset,
                paletteOffset,
                paletteOffset + fields[1],
            });

            return new Zspr {
                Title = title,
                Author = author,
                AuthorAscii = authorAscii,
                Content = content,
            };
        }

        private static byte[] ParseContent(Stream stream, IEnumerable<long> offsets) {
            using var content = new MemoryStream();
            foreach (var (length, offset) in fields.Zip(offsets, (l, o) => (l, o))) {
                stream.Position = offset;
                stream.CopyTo(content, length);
            }
            return content.ToArray();
        }

        private static string NullTerm(BinaryReader reader) {
            char c;
            var text = new StringBuilder();
            while ((c = reader.ReadChar()) > 0)
                text.Append(c);
            return text.ToString();
        }

    }

}
